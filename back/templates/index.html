<!doctype html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shared Folder</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="page">
    <div class="card" id="card-root">
      <!-- LOGIN/REGISTER (shown when not logged-in) -->
      <section id="login-section" style="{% if not logged_in %}display: block{% else %}display: none{% endif %}">
        <div class="login-container">
          <div class="login-header">
            <div class="logo">SF</div>
            <h2 id="form-title">Welcome back</h2>
            <p id="form-subtitle" class="muted">Sign in to access your shared folder</p>
          </div>
          <form id="auth-form" method="post" action="/login">
            <input name="username" placeholder="Username" required />
            <input type="password" name="password" placeholder="Password" required />
            <button type="submit" id="submit-btn">Sign in</button>
          </form>
          <div class="form-switch muted">
            <!-- This text will be toggled by JavaScript -->
            <span id="register-prompt">Don't have an account? <a href="#" id="register-toggle">Register</a></span>
            <span id="login-prompt" style="display:none;">Already have an account? <a href="#" id="login-toggle">Login</a></span>
          </div>
          <!-- Error/Success Messages will be displayed here -->
          <div id="error-message" class="error" style="display: {% if error %}block{% else %}none{% endif %}">{{ error or '' }}</div>
          <div id="success-message" class="success" style="display: {% if success %}block{% else %}none{% endif %}">{{ success or '' }}</div>
        </div>
      </section>

      <!-- APP (hidden until login succeeds) -->
      <div id="app" style="{% if logged_in %}display: block{% else %}display: none{% endif %}">
        <header class="header">
          <div class="brand">
            <div class="logo">SF</div>
            <div>
              <div class="title">Shared Folder</div>
              <!-- Display user's permission level -->
              <div class="muted">Permissions: <strong style="color: #3b82f6;">{{ permissions }}</strong></div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:14px">
            <!-- Admin Panel Button - only shows for admins -->
            {% if permissions == 'admin' %}
            <a href="/admin" class="btn-secondary">Admin Panel</a>
            {% endif %}
            <div class="realtime"><span style="width:9px;height:9px;background:#10b981;border-radius:50%;display:inline-block;margin-right:8px"></span>Live</div>
            <div id="logout-section" style="display:flex;align-items:center;gap:12px">
              <div id="greeting" style="font-weight:600;color:#0f172a">{{ 'Hello, ' + user_name if user_name else '' }}</div>
              <a href="/logout" id="logout-btn" class="btn-danger">Logout</a>
            </div>
          </div>
        </header>

        <main class="main">
          <!-- UPLOAD PANEL (Conditional based on permissions) -->
          {% if permissions in ['write', 'delete', 'admin'] %}
          <aside class="upload-panel">
            <h3 style="margin-bottom:8px">Upload files</h3>
            <div id="drop-cover" class="drop-cover">
              <p style="font-weight:700">Drag & drop anywhere on the page</p>
              <p class="hint">or click to select files (max 16MB each)</p>
              <div class="actions">
                <input id="file-input" name="file" type="file" multiple style="display:none" />
                <button id="select-file-btn" class="btn-primary" type="button">Select files</button>
              </div>
            </div>
          </aside>
          {% endif %}
          
          <!-- FILES PANEL (expands if upload panel is hidden) -->
          <section class="files-panel" {% if permissions not in ['write', 'delete', 'admin'] %}style="grid-column: 1 / -1;"{% endif %}>
            <div class="files-header">
              <div>
                <h3 style="margin:0">Uploaded files</h3>
                <div class="muted">Files uploaded by your team</div>
              </div>
              <div id="upload-stats" class="muted">{{ files|length }} files</div>
            </div>
            <div id="files-list" class="files-list">
              <ul id="file-list" style="list-style:none;padding:6px;margin:0">
                  {% for file in files %}
                  <li id="file-{{ file.filename }}" class="file-row">
                    <div style="width:44px;height:44px;display:flex;align-items:center;justify-content:center">
                      {% set ext = file.filename.split('.')[-1].lower() %}
                      {% if ext in ['pdf'] %}<i class="fa-solid fa-file-pdf" style="font-size:20px;color:#dc2626"></i>
                      {% elif ext in ['doc','docx'] %}<i class="fa-solid fa-file-word" style="font-size:20px;color:#2563eb"></i>
                      {% elif ext in ['xls','xlsx'] %}<i class="fa-solid fa-file-excel" style="font-size:20px;color:#16a34a"></i>
                      {% elif ext in ['png','jpg','jpeg'] %}<i class="fa-solid fa-file-image" style="font-size:20px;color:#ca8a04"></i>
                      {% elif ext in ['zip','rar'] %}<i class="fa-solid fa-file-archive" style="font-size:20px;color:#6b7280"></i>
                      {% else %}<i class="fa-solid fa-file" style="font-size:20px;color:#4b5563"></i>
                      {% endif %}
                    </div>
                    <div class="file-meta">
                      <div class="file-name">{{ file.filename }}</div>
                      <div class="file-sub"><div class="date">{{ file.upload_time }}</div><div>{{ (file.size / 1024) | round(1) }} KB</div></div>
                    </div>
                    <div class="file-actions">
                      <div class="menu-trigger" data-filename="{{ file.filename }}">â‹®</div>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>

  <div id="floating-menu" aria-hidden="true" data-permissions="{{ permissions }}"></div>
  <div id="global-drop-overlay" aria-hidden="true"><div class="overlay-card">Drop files to upload</div></div>
  
  <div id="delete-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 id="delete-modal-title">Delete file?</h3>
      <p>This action cannot be undone.</p>
      <div class="modal-actions">
        <button id="delete-cancel-btn" class="btn-secondary">Cancel</button>
        <button id="delete-confirm-btn" class="btn-danger">Delete</button>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>