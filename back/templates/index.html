<!doctype html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shared Folder</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="page">
    <div class="card" id="card-root">
      <!-- LOGIN/REGISTER -->
      <section id="login-section" style="{% if not logged_in %}display: block{% else %}display: none{% endif %}">
        <div class="login-container">
          <div class="login-header">
            <div class="logo">SF</div>
            <h2 id="form-title">Welcome back</h2>
            <p id="form-subtitle" class="muted">Sign in to access your shared folder</p>
          </div>
          <form id="auth-form" method="post" action="/login">
            <input name="username" placeholder="Username" required />
            <input type="password" name="password" placeholder="Password" required />
            <button type="submit" id="submit-btn">Sign in</button>
          </form>
          <div class="form-switch muted">
            <span id="register-prompt">Don't have an account? <a href="#" id="register-toggle">Register</a></span>
            <span id="login-prompt" style="display:none;">Already have an account? <a href="#" id="login-toggle">Login</a></span>
          </div>
          <div id="error-message" class="error" style="display: {% if error %}block{% else %}none{% endif %}; margin-top: 15px;">{{ error or '' }}</div>
          <div id="success-message" class="success" style="display: {% if success %}block{% else %}none{% endif %}; margin-top: 15px;">{{ success or '' }}</div>
        </div>
      </section>

      <!-- APP -->
      <div id="app" style="{% if logged_in %}display: block{% else %}display: none{% endif %}">
        <header class="header">
          <div class="brand">
            <div class="logo">SF</div>
            <div>
              <div class="title">Shared Folder</div>
              <div class="muted">Permissions: 
                <strong id="permission-display" style="color: #3b82f6;">
                    {% if permissions == 'read' %}Download Only
                    {% elif permissions == 'write' %}Download & Upload
                    {% elif permissions == 'delete' %}Download, Upload & Delete
                    {% elif permissions == 'admin' %}Full Access (Admin)
                    {% else %}{{ permissions }}
                    {% endif %}
                </strong>
              </div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:14px">
            <a href="/admin" class="btn-secondary" id="admin-btn" {% if permissions != 'admin' %}style="display:none;"{% endif %}>Admin Panel</a>
            <div class="realtime"><span class="live-indicator"></span>Live</div>
            <div id="logout-section" style="display:flex;align-items:center;gap:12px">
              <div id="greeting" style="font-weight:600;color:#0f172a">{{ 'Hello, ' + user_name if user_name else '' }}</div>
              <a href="/logout" id="logout-btn" class="btn-danger">Logout</a>
            </div>
          </div>
        </header>

        <!-- **FIX**: Corrected grid layout for admin view -->
        <main class="main" id="main-content">
          <aside class="upload-panel" id="upload-panel" {% if permissions not in ['write', 'delete', 'admin'] %}style="display:none;"{% endif %}>
            <h3 style="margin-bottom:8px">Upload files</h3>
            <div id="drop-cover" class="drop-cover">
              <p style="font-weight:700">Drag & drop to upload</p>
              <p class="hint">or select files manually</p>
              <div class="actions">
                <input id="file-input" name="file" type="file" multiple style="display:none" />
                <button id="select-file-btn" class="btn-primary" type="button">Select files</button>
              </div>
            </div>
          </aside>
          
          <section class="files-panel" id="files-panel">
            <div class="files-header">
              <div class="files-info">
                <h3 style="margin:0">Uploaded files</h3>
                <div class="muted">Files available to your team</div>
              </div>
              <div class="files-controls">
                <div id="upload-stats" class="muted">0 files</div>
                <div class="sort-dropdown">
                  <button class="sort-btn">Sort â–¾</button>
                  <div class="sort-menu">
                    <button data-sort="date">Date</button>
                    <button data-sort="name">Name</button>
                    <button data-sort="uploader">Uploader</button>
                    <button data-sort="size">Size</button>
                  </div>
                </div>
              </div>
            </div>
            <div id="files-list" class="files-list">
              <ul id="file-list" style="list-style:none;padding:6px;margin:0"></ul>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>

  <div id="floating-menu" aria-hidden="true" data-permissions="{{ permissions }}"></div>
  <div id="global-drop-overlay" aria-hidden="true"><div class="overlay-card">Drop files to upload</div></div>
  
  <div id="delete-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 id="delete-modal-title">Delete file?</h3>
      <p>This action cannot be undone.</p>
      <div class="modal-actions">
        <button id="delete-cancel-btn" class="btn-secondary">Cancel</button>
        <button id="delete-confirm-btn" class="btn-danger">Delete</button>
      </div>
    </div>
  </div>

  <!-- **FIX**: Embed initial files for reliable loading -->
  <script id="initial-files" type="application/json">
    {{ files | tojson | safe }}
  </script>

  <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
